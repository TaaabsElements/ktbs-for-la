<!-- LOCAL STYLESHEET -->
<link rel="import" href="./css/ktbs-for-la-style.html">
<!-- POLYMER APP HELPERS -->
<link rel="import" href="../app-layout/app-layout.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<!-- i18n -->
<link rel="import" href="../i18n-panel/i18n-panel.html">
<!-- Iron elements -->
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<!-- BASE -->
<link rel="import" href="../taaabs-base-overview/taaabs-base-overview.html">
<link rel="import" href="../taaabs-base-details/taaabs-base-details.html">
<link rel="import" href="../taaabs-base-graph/taaabs-base-graph.html">
<link rel="import" href="../taaabs-base-create/taaabs-base-create.html">
<link rel="import" href="../taaabs-research/taaabs-research.html">
<!-- TODO : METHOD -->
<link rel="import" href="../taaabs-method-details/taaabs-method-details.html">
<!-- TRACE -->
<!-- TODO CHANGE DEPENDECY HERE -->
<link rel="import" href="../taaabs-trace-details-container/taaabs-trace-details-container.html">
<link rel="import" href="../taaabs-trace-timeline-docker/taaabs-trace-timeline-docker.html">
<!-- COLLECTOR -->
<link rel="import" href="../taaabs-csv-collector/taaabs-csv-collector.html">
<!-- REQUESTS -->
<link rel="import" href="../../elements/taaabs-spare/taaabs-spare.html">
<!-- TAAABS -->
<link rel="import" href="../taaabs-taaabs/taaabs-taaabs.html">
<link rel="import" href="../taaabs-resource-loader/taaabs-resource-loader.html">
<link rel="import" href="./css/ktbs-for-la-style.html">
<link rel="import" href="../taaabs-themes/taaabs-theme.html">
<link rel="import" href="../notify-toast-behavior/notify-toast-behavior.html">
<!-- POLYMER -->
<link rel="import" href="../polymer/polymer.html">
<!-- ENOUGH WITH THE DEPENDENCIES !! -->
<dom-module id="ktbs-for-la">
  <template>
    <style include="taaabs-theme"></style>
    <style include="ktbs-for-la-style"></style>

    <!-- ROUTING COMPONENT -->
    <app-location route="{{_route}}" use-hash-as-path></app-location>
    <app-route route="[[_route]]" pattern="/page/:page" data="{{_routePage}}" tail="{{_tail}}">
    </app-route>


    <app-drawer-layout force-narrow>


      <!-- MENU DRAWER -->
      <app-drawer id="drawer" align="end">
        <div class="fgWhite menuHeader">
          <h3>MENU</h3>
        </div>
        <div class="fgWhite fgWhiteH clickable hoverable menuDiv">
          <a href="#/base-overview">{{localize('projects')}}</a>
        </div>
        <div class="fgWhite fgWhiteH clickable hoverable menuDiv" on-click="_onSearchClick">
          [[localize('search')]]
          <iron-icon icon='icons:search' class="small" style="float:right; vertical-align:text-bottom"></iron-icon>
        </div>
        <div class="fgWhite fgWhiteH clickable hoverable menuDiv" on-click="_onImportCSVClicked">
          [[localize('importcsv')]]
          <iron-icon icon='icons:file-upload' class="small" style="float:right; vertical-align:text-bottom"></iron-icon>
        </div>
        <div class="fgWhite fgWhiteH clickable hoverable menuDiv">
          [[localize('settings')]]
          <iron-icon icon='icons:settings' class="tiny" style="float:right; vertical-align:text-bottom"></iron-icon>
        </div>
        <div class="fgWhite fgWhiteH clickable hoverable menuDiv">
          <a href="/help/fr/index.html" target="_blank">[[localize('help')]]</a>
          <iron-icon icon='icons:help-outline' class="tiny" style="float:right; vertical-align:text-bottom"></iron-icon>
        </div>
        <div>
          <i18n-panel style="float:right" language="{{language}}"></i18n-panel>
        </div>
      </app-drawer>

      <!-- HEADER TOOLBAR -->
      <app-header fixed>
        <app-toolbar >
          <div id="homeBtn" class="fgWhite fgWhiteH clickable hoverable" on-click="_home">KTBS4LA</div>
          <iron-icon id="drawerBtn" class="fgWhite fgWhiteH clickable hoverable" icon="icons:menu" on-click='_toggleDrawer'></iron-icon>
        </app-toolbar>
      </app-header>

      <paper-dialog id="research-dialog">
        <div class="flex-vertical">
          <taaabs-research id="research" style="width: 1000px; min-height: 400px" ktbs-url="[[ktbsUrl]]" language="[[language]]"></taaabs-research>
          <div class="flex-horizontal flex-equal-around-justified">
            <paper-button class="fgWhite bgLog bgLogH hoverable" raised on-click="_onExploreHereClick">Explore here <iron-icon icon="icons:open-in-new"></iron-icon></paper-button>
            <paper-button class="fgWhite bgLog bgLogH hoverable" raised on-click="_onExploreNewWindowClick">Explore in new window <iron-icon icon="icons:open-in-browser"></iron-icon></paper-button>
          </div>
        </div>
      </paper-dialog>

      <!-- Notify toast -->
      <paper-toast id="__notify_toast__" style="background-color:rgba(0,0,0,0.37)" duration=0> </paper-toast>

      <!-- SECTIONS -->
      <iron-pages attr-for-selected="data-route" selected="[[_routePage.page]]">

        <!-- HOME PAGE -->
        <section class="page" data-route="home">
          <div id="home" class="flexchild-vertical">
            <div>
              <div>
                <center>
                  <h2>KTBS 4 LA</h2>
                  <p>{{localize('welcome')}}</p>
                </center>
              </div>
            </div>
          </div>
          <div id="base-list" class="centered swag-scroll">
            <h2> {{localize('pickAProject')}} </h2>
            <taaabs-resource-loader resources={{shared_resources}} is-loading={{shared_loading_resources_status}} loading-list={{shared_loading_resources}}>
              <taaabs-base-overview id="tbo" ktbs-url="{{ktbsUrl}}" language="[[language]]" taaabs-central-loading>
              </taaabs-base-overview>
            </taaabs-resource-loader>
          </div>
        </section>

        <!-- TAAABS CSV COLLECTOR -->
        <section class="page" data-route="csv-collector">
          <div>
            <taaabs-resource-loader resources={{shared_resources}} is-loading={{shared_loading_resources_status}} loading-list={{shared_loading_resources}}>
              <taaabs-csv-collector id="tcc" language="[[language]]" taaabs-central-loading></taaabs-csv-collector>
            </taaabs-resource-loader>
          </div>
        </section>


        <!-- TAAABS BASE DETAILS -->
        <section class="page fit-width flex-vertical" data-route="base-details">
          <div>
            <iron-collapse id="baseGraphCollapse" opened>
              <taaabs-resource-loader resources={{shared_resources}} is-loading={{shared_loading_resources_status}} loading-list={{shared_loading_resources}}>
                <taaabs-base-graph id="tbg" taaabs-central-loading height="300px" bg-color="#2e3842" language="[[language]]">
                </taaabs-base-graph>
              </taaabs-resource-loader>
            </iron-collapse>
            <div class="fit-width bgDarkBlue" style="padding:2px; text-align: center">
              <iron-icon id="baseGraphIcon" class="clickable hoverable fgWhite fgWhiteH" icon="icons:expand-less" on-click="_onToggleBaseGraph"> </iron-icon>
            </div>
            <div id="base-details-icons" class="fit-width bgDarkBlue">
              <div class="centered flex-horizontal flex-equal-around-justified">
                <div class="fgWhite fgWhiteH hoverable clickable">
                  <iron-icon class="fgWhiteH hoverable" icon="icons:file-upload" title="{{localize('importcsv')}}" on-click="_onImportCSVClicked"></iron-icon>
                </div>
                <div class="fgWhite fgWhiteH hoverable clickable" on-click='_onCreateBaseClick'>
                  <iron-icon class="fgWhiteH hoverable" icon="icons:add" style="vertical-align:baseline"></iron-icon>B </div>
                <div class="fgWhite fgWhiteH hoverable clickable">
                  <iron-icon class="fgWhiteH hoverable" icon="icons:add" style="vertical-align:baseline"></iron-icon>ST </div>
                <div class="fgWhite fgWhiteH hoverable clickable">
                  <iron-icon class="fgWhiteH hoverable" icon="icons:add" style="vertical-align:baseline"></iron-icon>CT </div>
                <div class="fgWhite fgWhiteH hoverable clickable">
                  <iron-icon class="fgWhiteH hoverable" icon="icons:add" style="vertical-align:baseline"></iron-icon>M </div>
              </div>
            </div>
          </div>
          <div style="padding-top: 5px;" class="centered swag-scroll flexchild">
            <taaabs-resource-loader resources={{shared_resources}} is-loading={{shared_loading_resources_status}} loading-list={{shared_loading_resources}}>
              <taaabs-base-details id="tbd" language="[[language]]" taaabs-central-loading>
              </taaabs-base-details>
            </taaabs-resource-loader>
          </div>
          <paper-dialog id="base-create-modal" style="min-width: 800px; padding:24px" no-cancel-on-esc-key no-cancel-on-outside-click>
            <taaabs-resource-loader resources={{shared_resources}} is-loading={{shared_loading_resources_status}} loading-list={{shared_loading_resources}}>
              <taaabs-base-create id="base-create" language="[[language]]" in-base  taaabs-central-loading></taaabs-base-create>
            </taaabs-resource-loader>
          </paper-dialog>
        </section>

        <!-- TAAABS TRACE DETAILS -->
        <section class="page" data-route="trace-details">
          <taaabs-resource-loader style="width: 100%; height: 100%" resources={{shared_resources}} is-loading={{shared_loading_resources_status}} loading-list={{shared_loading_resources}}>
            <taaabs-trace-details-container id="trace-details-container" language="[[language]]" taaabs-central-loading>
            </taaabs-trace-details-container>
          </taaabs-resource-loader>
        </section>

        <!-- WORK IN PROGRESS -->
        <!--
        <section class="page" data-route="generic-method-from-trace">
          <taaabs-generic-method id="tgmFT" from-trace="{{_decodeUrl(_routeDatas.resourceurl)}}" language="[[language]]">
          </taaabs-generic-method>
        </section>
       -->

        <!-- TAAABS TRACE TIMELINE -->
        <section class="page" data-route="trace-timeline">
          <taaabs-trace-timeline-docker id="ttt" language="[[language]]"></taaabs-trace-timeline-docker>
        </section>

        <!-- TAAABS METHOD DETAILS -->
        <section class="page" data-route="method-details">
          <taaabs-method-details id="method-details" language="[[language]]"></taaabs-method-details>
        </section>

        <!-- TAAABS TRACE SPARE -->
        <section class="page" data-route="spare">
          <div class="centered">
            <taaabs-resource-loader resources={{shared_resources}} is-loading={{shared_loading_resources_status}} loading-list={{shared_loading_resources}}>
              <taaabs-spare id="ts" taaabs-central-loading language="[[language]]">
              </taaabs-spare>
            </taaabs-resource-loader>
          </div>
        </section>

      </iron-pages>

    </app-drawer-layout>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'ktbs-for-la',
        properties: {

          /**
           * Url of the ktbs we're working with.
           *
           * @attribute ktbsUrl
           * @type String
           */
          ktbsUrl: {
            type: String,
            notify: true,
            value: ""
          },

          /**
           * Url of the current base if there's one.
           *
           * @attribute _baseUrl
           * @type String
           */
          _baseUrl: {
            type: String,
            notify: true,
            value: ""
          },

          //////////
          // I18N //
          //////////

          /**
           * Localization.
           * fr, en.
           *
           * @attribute language
           * @type String
           */
          language: {
            type: String,
            notify: true,
            value: 'fr'
          },

          /////////////
          // ROUTING //
          /////////////

          /**
           * First part of the route.
           * Represents the section we're displaying from the iron-page.
           *
           * @attribute _route
           * @type Object
           */
          _route: {
            type: Object,
            notify: true,
          },

          /**
           * The data of `_route`, according to the pattern '/:page'.
           *
           * @attribute _routePage
           * @type Object
           */
          _routePage: {
            type: Object,
            notify: true,
          },

          /**
           * The datas of `_route`, according to the pattern '/:page/:resourceurl'.
           *
           * @attribute _routeDatas
           * @type Object
           */
          _routeDatas: {
            type: Object,
            notify: true,
          },

          /**
           * An object containing the rest of the page datas.
           *
           * @attribute _routeTails
           * @type Object
           */
          _routeTails: {
            type: Object,
            notify: true,
          }

        },
        observers: [
          '_onRoutePathChanged(_routePage)'
        ],
        behaviors: [
          Polymer.AppLocalizeBehavior,
          NotifyToastBehavior
        ],
        ready: function() {},

        attached: function() {
          // Load i18n json.
          this.loadResources(this.resolveUrl('./languages/locales.json'));

          // Set event listener for taaabs-base-overview component.
          this.$.tbo.addEventListener('BASE_SELECTED', function(e) {
            console.log(e);
            if (e.detail.which !== 2) {
              this.set('_route.path', '/page/base-details/path/' + e.detail.baseId);
            } else {
              window.open('#/page/base-details/path/' + e.detail.baseId);
            }
          }.bind(this));

          //Set event listener for taaabs-base-graph
          this.$.tbg.addEventListener('REFRESHED', function() {
            this.$.tbd.refresh();
          }.bind(this));

          // Set event listerner for taaabs-base-details component.
          this.$.tbd.addEventListener('RESOURCE_SELECTED', function(e) {

            // this.$.baseDetailsModal.open();
            // .resource
            if (e.detail.resource['@type'] === "StoredTrace" || e.detail.resource['@type'] === "ComputedTrace") {
              if (e.detail.which !== 2) {
                // Get the path to the base
                var url = "";
                // Get the path to the base
                var url = "";
                var source_url = e.detail.resource.uri.replace(this.ktbsUrl, '');
                url = 'path/' + source_url;
                // Set the enw route
                this.set('_route.path', '/page/trace-details/' + url);
              } else {
                window.open('#/page/trace-details/' + url);
              }
            } else if (e.detail.resource['@type'] === "Base") {
              if (e.detail.which !== 2) {
                // Get the path to the base
                var url = "";
                var source_url = e.detail.resource.uri.replace(this.ktbsUrl, '');
                url = 'path/' + source_url;
                // Set the enw route
                this.set('_route.path', '/page/base-details/' + url);
              } else {
                window.open('#/page/base-details/' + url);
              }
            } else if (e.detail.resource['@type'] === "Method") {
              if (e.detail.which !== 2) {
                // Get the path to the base
                var url = "";
                var source_url = e.detail.resource.uri.replace(this.ktbsUrl, '');
                url = 'path/' + source_url;
                // Set the enw route
                this.set('_route.path', '/page/method-details/' + url);
              } else {
                window.open('#/page/method-details/' + url);
              }
            }

          }.bind(this));

          this.$.tbd.addEventListener('RESOURCE_CHANGED', function() {
            this.$.tbg.refresh();
          }.bind(this));

          this.$['base-create'].addEventListener('base-creation-canceled', function(){
            this.$['base-create-modal'].close();
          }.bind(this));

          this.$['base-create'].addEventListener('base-created', function(evt){
            this.$['base-create-modal'].close();
            var msg = this.localize('base-creation-success-1') + evt.detail.base_path + this.localize('base-creation-success-2');
            this.notifyToast(msg,{
              type: "Success",
              timeout: -1
            });
            this.$.tbg.refresh();
          }.bind(this));

          this.$['trace-details-container'].addEventListener('timeline-link-clicked', function(){
            window.open('#/page/trace-timeline' + this._tail.path);
          }.bind(this))

        },

        //////////////////////////////
        // USER INTERFACE FUNCTIONS //
        //////////////////////////////

        _onCreateBaseClick: function(){
          var tail = "";
          if (this._tail.path) {
            tail = this._tail.path.split(/\/\b/g);
            if (tail[0] === "") tail.splice(0, 1);
          }
          this.$['base-create'].set('baseRelativeUrl', this._getResourceUrl(tail));
          this.$['base-create'].set('baseUrl', this.ktbsUrl + this._getResourceUrl(tail));
          this.$['base-create'].refresh();
          this.$['base-create-modal'].open();
        },

        _onSearchClick: function(){
          this.$['research-dialog'].open();
        },

        _onExploreHereClick: function(){
          var url = this.$.research.get('resourceUrl');
          url.replace(this.ktbsUrl, '');
          var type = this.$.research.get('resource')['@type'];
          var path = "/page/";
          if(type === "Base"){
            path += 'base-details/path/'+url;
          }
          else if(type === "TraceModel"){
            // TODO Compelte with model page
            return;
          }
          else if(type === "StoredTrace" || type === "ComputedTrace"){
            path += 'trace-details/path/'+url;
          }
          else if(type=== "Method"){
            path += 'method-details/path/'+url;
          }
          else{
            return;
          }
          this.set('_route.path', path);
          this.$['research-dialog'].close();
          this.$.drawer.toggle();
        },

        _onExploreNewWindowClick: function(){
          var url = this.$.research.get('resourceUrl');
          url.replace(this.ktbsUrl, '');
          var type = this.$.research.get('resource')['@type'];
          var path = "/page/";
          if(type === "Base"){
            path += 'base-details/path/'+url;
          }
          else if(type === "TraceModel"){
            // TODO Compelte with model page
            return;
          }
          else if(type === "StoredTrace" || type === "ComputedTrace"){
            path += 'trace-details/path/'+url;
          }
          else if(type=== "Method"){
            path += 'method-details/path/'+url;
          }
          else{
            return;
          }
          window.open('#'+path);
        },

        /**
         * `#homeBtn` on-click function.
         *
         * @method _home
         */
        _home: function() {
          this.set('_route.path', '/page/home/');
        },

        /**
         * `#drawerBtn` on-click function.
         *
         * @method _toggleDrawer
         */
        _toggleDrawer: function() {
          this.$.drawer.toggle();
        },

        /**
         * "Import csv" button on-click function.
         *
         * @method _onImportCSVClicked
         */
        _onImportCSVClicked: function() {
          var tail = this._tail.path;
          this.set('_route.path', '/page/csv-collector' + tail);
        },

        ///////////////////////
        // ROUTING FUNCTIONS //
        ///////////////////////

        /**
         * Returns an url from the route.
         */
        _getResourceUrl: function(array) {
          var url = "";
          var resources = ["path"];
          var i = 0;
          while (i < array.length) {
            if (array[i] !== "path")
              url += array[i] + '/';
            i++;
          }
          url = url.substring(0, url.length - 1);
          return url;
        },

        /**
         * `_route.path` observer function.
         *
         * @param {!required} path {String} '_route.path'.
         *
         * @method _onRoutePathChanged
         */
        _onRoutePathChanged: function(path) {

          // Delay the route function
          this.async(function() {
            var page = path.page;
            if (this._tail.path) {
              var tail = this._tail.path.split(/\/\b/g);
              if (tail[0] === "") tail.splice(0, 1);
            }

            if (!page || page === '') {
              this.set('_route.path', '/page/home/');
            }

            if(this._tail.path !== this._lastPath || page !== this._lastPage){

              this.set('_lastPath', this._tail.path);
              this.set('_lastPage', page);

              if (!page || page === '') {
                this.set('_route.path', '/page/home/');
              } else if (page === 'home') {
                this.$.tbo.refresh();
              } else if (page === 'base-details') {
                this.$.tbg.baseUrl = this.$.tbd.baseUrl = this.ktbsUrl + this._getResourceUrl(tail);
                this.$.tbg.refresh();
              } else if (page === 'base-overview') {
                this.$.tbo.refresh();
              } else if (page === 'trace-timeline') {
                this.$.ttt.set('traceUrl', this.ktbsUrl + this._getResourceUrl(tail));
                this.$.ttt.refresh();
              } else if (page === 'spare') {
                this.$.ts.set('traceUrl', this.ktbsUrl + this._getResourceUrl(tail));
                this.$.ts.refresh();
              } else if (page === 'csv-collector') {
                this.$.tcc.baseUrl = this.ktbsUrl + this._getResourceUrl(tail);
                this.$.tcc.refresh();
              } else if (page === 'trace-details') {
                this.$['trace-details-container'].traceUrl = this.ktbsUrl + this._getResourceUrl(tail);
                this.$['trace-details-container'].refresh();
              } else if (page === 'method-details') {
                // TODO
                this.$['method-details'].methodUrl = this.ktbsUrl + this._getResourceUrl(tail);
                this.$['method-details'].refresh();
              }
            }
            window.scrollTo(0, 0);
          }, 150);

          // If we do not have an initial URL, we redirect to /home/

        },

        /**
         * Decode an encoded URL. Called by components as taaabs-base-details.
         *
         * @param {!required} url {String} An encoded URL.
         *
         * @method _decodeUrl
         */
        _decodeUrl: function(url) {
          return decodeURIComponent(url);
        },

        /**
         * BASE-DETAILS VIEW FUNCTIONS
         **/

        _onToggleBaseGraph: function() {
          (this.$.baseGraphCollapse.opened) ? this.$.baseGraphIcon.set('icon', 'icons:expand-more'): this.$.baseGraphIcon.set('icon', 'icons:expand-less');
          this.$.baseGraphCollapse.toggle();
        }
      });
    })();
  </script>
</dom-module>
